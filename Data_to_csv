from brainflow.board_shim import BoardShim, BoardIds, BrainFlowInputParams
import csv
import time

def main():
    params = BrainFlowInputParams()
    params.serial_port = "COM3"  # Modify this port based on your Ganglion board's serial port

    board_id = BoardIds.GANGLION_BOARD.value
    print(board_id)

    try:
        board = BoardShim(board_id, params)
        board.prepare_session()
        print("Successfully prepared physical board.")
    except Exception as e:
        print(e)
        print("Device could not be found or is being used by another program.")
        return

    print("Starting Stream")
    board.start_stream()

    # Collect data in lists
    eeg_data = []
    timestamps = []
    
    # Live streaming for 10 seconds (you can modify the duration as needed)
    duration = 10  # in seconds
    start_time = time.time()
    
    while (time.time() - start_time) < duration:
        data = board.get_current_board_data(256)  # Fetch 256 samples per iteration
        eeg_data.append(data)  # Append data directly (all channels) to the list
        timestamps.append(time.time())
        
        time.sleep(0.1)  # Adjust sleep time based on your requirements for data processing

    print("Ending Stream")
    board.stop_stream()
    board.release_session()

    # Save the collected data to a CSV file
    save_to_csv(eeg_data, timestamps)

def save_to_csv(data, timestamps):
    csv_filename = "eeg_data.csv"

    # Prepare the header for the CSV file
    header = ["timestamp"] + [f"eeg_{i}" for i in range(len(data[0]))]
    
    # Write data to the CSV file
    with open(csv_filename, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(header)
        
        for timestamp, eeg_values in zip(timestamps, data):
            row = [timestamp] + list(eeg_values.flatten())  # Flatten multi-channel EEG data into a single row
            writer.writerow(row)

if __name__ == "__main__":
    main()
